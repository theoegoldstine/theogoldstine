<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Travel — Theo Goldstine</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #050a05;
      color: #00ff88;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 400;
      min-height: 100vh;
      overflow: hidden;
      cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Cg transform='rotate(-45 16 16)'%3E%3Cpath d='M15 3 L17 3 L17 11 L27 18 L27 20 L17 16 L17 24 L20 26 L20 28 L16 27 L12 28 L12 26 L15 24 L15 16 L5 20 L5 18 L15 11Z' fill='%2300ff88'/%3E%3Cpath d='M15 3 L17 3 L17 11 L27 18 L27 20 L17 16 L17 24 L20 26 L20 28 L16 27 L12 28 L12 26 L15 24 L15 16 L5 20 L5 18 L15 11Z' stroke='%2300cc66' stroke-width='0.5' fill='none'/%3E%3C/g%3E%3C/svg%3E") 16 16, crosshair;
    }

    /* CRT scanline overlay */
    .scanlines {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 100;
      pointer-events: none;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, 0.08) 2px,
        rgba(0, 0, 0, 0.08) 4px
      );
    }

    .vignette {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 99;
      pointer-events: none;
      background: radial-gradient(ellipse at center, transparent 50%, rgba(0, 5, 0, 0.8) 100%);
    }

    #globe-container {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0;
    }

    .header {
      position: fixed;
      top: 0; left: 0; width: 100%;
      z-index: 10;
      padding: 1.2rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(0, 255, 136, 0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .header .prompt {
      color: #00ff88;
      font-size: 0.75rem;
      opacity: 0.5;
    }

    .header h1 {
      font-weight: 500;
      font-size: 0.8rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #00ff88;
    }

    .header a {
      font-size: 0.7rem;
      font-weight: 400;
      color: rgba(0, 255, 136, 0.4);
      text-decoration: none;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      border: 1px solid rgba(0, 255, 136, 0.15);
      padding: 0.3rem 0.8rem;
      transition: all 0.2s;
    }

    .header a:hover {
      color: #00ff88;
      border-color: #00ff88;
      background: rgba(0, 255, 136, 0.05);
    }

    .info-panel {
      position: fixed;
      bottom: 1.5rem;
      left: 1.5rem;
      z-index: 10;
      pointer-events: none;
    }

    .stat-block {
      border: 1px solid rgba(0, 255, 136, 0.15);
      padding: 1rem 1.2rem;
      background: rgba(0, 10, 0, 0.7);
      backdrop-filter: blur(10px);
    }

    .stat-label {
      font-size: 0.55rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: rgba(0, 255, 136, 0.4);
      margin-bottom: 0.3rem;
    }

    .stat-value {
      font-size: 2.2rem;
      font-weight: 700;
      color: #00ff88;
      line-height: 1;
      text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
    }

    .stat-sub {
      font-size: 0.6rem;
      color: rgba(0, 255, 136, 0.3);
      margin-top: 0.3rem;
    }

    .country-hover {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      text-align: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;
      border: 1px solid rgba(0, 255, 136, 0.4);
      padding: 1.5rem 2.5rem;
      background: rgba(0, 10, 0, 0.85);
      backdrop-filter: blur(15px);
      box-shadow: 0 0 30px rgba(0, 255, 136, 0.15), inset 0 0 30px rgba(0, 255, 136, 0.03);
    }

    .country-hover.visible { opacity: 1; }

    .country-hover .name {
      font-size: 1.6rem;
      font-weight: 700;
      color: #00ff88;
      text-shadow: 0 0 20px rgba(0, 255, 136, 0.6), 0 0 40px rgba(0, 255, 136, 0.2);
      letter-spacing: 0.05em;
    }

    .country-hover .native {
      font-size: 0.9rem;
      font-weight: 300;
      color: rgba(0, 255, 136, 0.45);
      margin-top: 0.1rem;
    }

    .country-hover .region {
      font-size: 0.6rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: rgba(0, 255, 136, 0.5);
      margin-top: 0.4rem;
    }

    .country-hover .dates {
      font-size: 0.75rem;
      color: #00ff88;
      margin-top: 0.6rem;
      text-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
    }

    .country-hover .status {
      font-size: 0.5rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      margin-top: 0.4rem;
      color: rgba(0, 255, 136, 0.4);
    }

    .country-list {
      position: fixed;
      top: 4rem;
      right: 1.5rem;
      z-index: 10;
      pointer-events: none;
      max-height: calc(100vh - 8rem);
      overflow: hidden;
    }

    .country-list ul {
      list-style: none;
      columns: 2;
      column-gap: 1.5rem;
    }

    .country-list li {
      font-size: 0.55rem;
      letter-spacing: 0.08em;
      color: rgba(0, 255, 136, 0.45);
      padding: 0.15rem 0;
      white-space: nowrap;
    }

    .country-list li .marker {
      color: #00ff88;
      margin-right: 0.3rem;
      text-shadow: 0 0 8px rgba(0, 255, 136, 0.6);
    }

    .coords {
      position: fixed;
      top: 4rem;
      left: 1.5rem;
      z-index: 10;
      pointer-events: none;
      font-size: 0.6rem;
      color: rgba(0, 255, 136, 0.4);
      line-height: 1.8;
    }

    .coords .val {
      color: rgba(0, 255, 136, 0.7);
    }

    .audio-prompt {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 50;
      border: 1px solid rgba(0, 255, 136, 0.4);
      padding: 0.6rem 1rem;
      background: rgba(0, 10, 0, 0.85);
      backdrop-filter: blur(10px);
      cursor: pointer;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.6rem;
      letter-spacing: 0.1em;
      color: #00ff88;
      text-transform: uppercase;
      animation: pulse-border 2s ease-in-out infinite;
      transition: opacity 0.4s, transform 0.4s;
    }

    .audio-prompt:hover {
      background: rgba(0, 255, 136, 0.1);
      border-color: #00ff88;
    }

    .audio-prompt.hidden {
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
    }

    @keyframes pulse-border {
      0%, 100% { border-color: rgba(0, 255, 136, 0.2); }
      50% { border-color: rgba(0, 255, 136, 0.6); }
    }

    @media (max-width: 768px) {
      .country-list { display: none; }
      .coords { display: none; }
      .header { padding: 1rem; }
      .info-panel { bottom: 1rem; left: 1rem; }
      .country-hover { bottom: 1rem; right: 1rem; }
      .stat-value { font-size: 1.6rem; }
    }
  </style>
</head>
<body>

<div class="scanlines"></div>
<div class="vignette"></div>
<div id="globe-container"></div>

<div class="header">
  <div class="header-left">
    <span class="prompt">theo@earth:~$</span>
    <h1>travel.log</h1>
  </div>
  <a href="noir.html">[esc] back</a>
</div>

<div class="coords" id="coords">
  <div>ROT_X: <span class="val" id="rot-x">0.000</span></div>
  <div>ROT_Y: <span class="val" id="rot-y">0.000</span></div>
  <div>ZOOM: <span class="val" id="zoom-val">3.00</span></div>
  <div>FPS: <span class="val" id="fps-val">60</span></div>
</div>

<div class="country-list">
  <ul id="country-ul"></ul>
</div>

<div class="info-panel">
  <div class="stat-block">
    <div class="stat-label">countries visited</div>
    <div class="stat-value">29</div>
    <div class="stat-sub">/ 195 total &mdash; 14.9%</div>
  </div>
</div>

<div class="country-hover" id="country-hover">
  <div class="name" id="hover-name"></div>
  <div class="native" id="hover-native"></div>
  <div class="region" id="hover-region"></div>
  <div class="dates" id="hover-dates"></div>
  <div class="status" id="hover-status"></div>
</div>

<div class="audio-prompt" id="audio-prompt">> click to enable audio — hover countries to hear anthems</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

// ── Data ──────────────────────────────────────────────

// Keys here match the `properties.name` values from the TopoJSON (countries-50m)
const VISITED_DATA = {
  'United States of America': { display: 'United States',  native: 'United States',     region: 'North America',   dates: 'Home',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/6/65/Star_Spangled_Banner_instrumental.ogg' },
  'Mexico':                    { display: 'Mexico',         native: 'México',            region: 'North America',   dates: '2010, 2024, 2025',          anthem: 'https://upload.wikimedia.org/wikipedia/commons/9/9d/Himno_Nacional_Mexicano_instrumental.ogg' },
  'United Kingdom':            { display: 'United Kingdom', native: 'United Kingdom',    region: 'Europe',          dates: '2022, 2024, 2025, 2026',    anthem: 'https://upload.wikimedia.org/wikipedia/commons/0/03/United_States_Navy_Band_-_God_Save_the_Queen.oga' },
  'Turkey':                    { display: 'Turkiye',        native: 'Türkiye',           region: 'Europe / Asia',   dates: '2022',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/9/99/Istikl%C3%A2l_Marsi_instrumetal.ogg' },
  'Switzerland':               { display: 'Switzerland',    native: 'Schweiz',           region: 'Europe',          dates: '2026',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/e/ee/Swiss_Psalm_%28official_instrumental%29.ogg' },
  'Spain':                     { display: 'Spain',          native: 'España',            region: 'Europe',          dates: '2024, 2025',                 anthem: 'https://upload.wikimedia.org/wikipedia/commons/8/81/Himno_Nacional_de_Espa%C3%B1a.ogg' },
  'Portugal':                  { display: 'Portugal',       native: 'Portugal',          region: 'Europe',          dates: '2025',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/5/58/A_Portuguesa.ogg' },
  'Poland':                    { display: 'Poland',         native: 'Polska',            region: 'Europe',          dates: '2025',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Mazurek_Dabrowskiego.ogg' },
  'Netherlands':               { display: 'Netherlands',    native: 'Nederland',         region: 'Europe',          dates: '2022, 2023',                 anthem: 'https://upload.wikimedia.org/wikipedia/commons/2/2e/United_States_Navy_Band_-_Het_Wilhelmus.ogg' },
  'Italy':                     { display: 'Italy',          native: 'Italia',            region: 'Europe',          dates: '2013, 2022, 2025',          anthem: 'https://upload.wikimedia.org/wikipedia/commons/0/0e/Inno_di_Mameli_instrumental.ogg' },
  'Ireland':                   { display: 'Ireland',        native: 'Éire',              region: 'Europe',          dates: '2025',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/7/7c/United_States_Navy_Band_-_Amhr%C3%A1n_na_bhFiann.ogg' },
  'Iceland':                   { display: 'Iceland',        native: 'Ísland',            region: 'Europe',          dates: '2025',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/4/4b/Lofs%C3%B6ngur.ogg' },
  'Hungary':                   { display: 'Hungary',        native: 'Magyarország',      region: 'Europe',          dates: '2025',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/6/63/Hu-magyarhimnusz.ogg' },
  'Greece':                    { display: 'Greece',         native: 'Ελλάδα',            region: 'Europe',          dates: '2022',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/d/db/Hymn_to_liberty_instrumental.oga' },
  'Germany':                   { display: 'Germany',        native: 'Deutschland',       region: 'Europe',          dates: '2022, 2024, 2025',          anthem: 'https://upload.wikimedia.org/wikipedia/commons/a/a6/German_national_anthem_performed_by_the_US_Navy_Band.ogg' },
  'France':                    { display: 'France',         native: 'France',            region: 'Europe',          dates: '2016, 2022, 2025',          anthem: 'https://upload.wikimedia.org/wikipedia/commons/3/30/La_Marseillaise.ogg' },
  'Czechia':                   { display: 'Czechia',        native: 'Česko',             region: 'Europe',          dates: '2025',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/6/6e/Czech_anthem.ogg' },
  'Belgium':                   { display: 'Belgium',        native: 'België',            region: 'Europe',          dates: '2022',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/e/e8/La_Braban%C3%A7onne.oga' },
  'Austria':                   { display: 'Austria',        native: 'Österreich',        region: 'Europe',          dates: '2022, 2025',                 anthem: 'https://upload.wikimedia.org/wikipedia/commons/7/7c/Land_der_Berge_Land_am_Strome_instrumental.ogg' },
  'Thailand':                  { display: 'Thailand',       native: 'ประเทศไทย',           region: 'Southeast Asia',  dates: '2024',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/f/f3/Thai_National_Anthem_-_US_Navy_Band.ogg' },
  'Taiwan':                    { display: 'Taiwan',         native: '臺灣',               region: 'East Asia',       dates: '2024',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/9/98/National_Anthem_of_the_Republic_of_China.ogg' },
  'South Korea':               { display: 'South Korea',    native: '대한민국',              region: 'East Asia',       dates: '2024',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/0/0c/The_National_Anthem_of_the_Republic_of_Korea.ogg' },
  'Japan':                     { display: 'Japan',          native: '日本',               region: 'East Asia',       dates: '2024',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/a/a3/Kimi_ga_Yo_instrumental.ogg' },
  'Israel':                    { display: 'Israel',         native: 'ישראל',             region: 'Middle East',     dates: '2012, 2022, 2023, 2025',    anthem: 'https://upload.wikimedia.org/wikipedia/commons/2/26/Hatikvah_instrumental.ogg' },
  'India':                     { display: 'India',          native: 'भारत',               region: 'South Asia',      dates: '2023, 2024',                 anthem: 'https://upload.wikimedia.org/wikipedia/commons/9/94/Jana_Gana_Mana_instrumental.ogg' },
  'China':                     { display: 'China',          native: '中国',               region: 'East Asia',       dates: '2024',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/b/b9/March_of_the_Volunteers_instrumental.ogg' },
  'Morocco':                   { display: 'Morocco',        native: 'المغرب',             region: 'North Africa',    dates: '2025',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/3/3f/National_Anthem_of_Morocco.ogg' },
  'Argentina':                 { display: 'Argentina',      native: 'Argentina',         region: 'South America',   dates: '2025',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/c/cd/Himno_Nacional_Argentino_instrumental.ogg' },
  'Uruguay':                   { display: 'Uruguay',        native: 'Uruguay',           region: 'South America',   dates: '2025',                       anthem: 'https://upload.wikimedia.org/wikipedia/commons/2/2b/United_States_Navy_Band_-_National_Anthem_of_Uruguay_%28complete%29.ogg' },
};
const VISITED_SET = new Set(Object.keys(VISITED_DATA));


// ── Populate sidebar list ─────────────────────────────

const ul = document.getElementById('country-ul');
Object.values(VISITED_DATA).map(v => v.display).sort().forEach(name => {
  const li = document.createElement('li');
  li.innerHTML = `<span class="marker">+</span>${name}`;
  ul.appendChild(li);
});

// ── Three.js scene ────────────────────────────────────

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, innerWidth / innerHeight, 0.1, 1000);
camera.position.z = 3;

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setClearColor(0x050a05);
document.getElementById('globe-container').appendChild(renderer.domElement);

// Controls
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.05;
controls.rotateSpeed = 0.5;
controls.enableZoom = true;
controls.minDistance = 1.6;
controls.maxDistance = 6;
controls.enablePan = false;
controls.autoRotate = true;
controls.autoRotateSpeed = 0.3;

// ── Build globe texture on canvas ─────────────────────

const TEX_W = 4096;
const TEX_H = 2048;

function projectEquirectangular(lng, lat) {
  const x = (lng + 180) / 360 * TEX_W;
  const y = (90 - lat) / 180 * TEX_H;
  return [x, y];
}

// Decode TopoJSON
function decodeArcs(topology) {
  const { arcs, transform } = topology;
  const decoded = [];
  for (const arc of arcs) {
    const coords = [];
    let x = 0, y = 0;
    for (const [dx, dy] of arc) {
      x += dx; y += dy;
      coords.push([
        x * transform.scale[0] + transform.translate[0],
        y * transform.scale[1] + transform.translate[1]
      ]);
    }
    decoded.push(coords);
  }
  return decoded;
}

function ringCoords(arcIndices, decodedArcs) {
  const coords = [];
  for (const idx of arcIndices) {
    const arc = idx < 0 ? [...decodedArcs[~idx]].reverse() : decodedArcs[idx];
    for (let i = 0; i < arc.length; i++) {
      if (i > 0 || coords.length === 0) coords.push(arc[i]);
    }
  }
  return coords;
}

function getPolygons(geometry, decodedArcs) {
  if (geometry.type === 'Polygon') {
    return [geometry.arcs.map(ring => ringCoords(ring, decodedArcs))];
  } else if (geometry.type === 'MultiPolygon') {
    return geometry.arcs.map(poly => poly.map(ring => ringCoords(ring, decodedArcs)));
  }
  return [];
}

async function buildGlobeTexture() {
  const res = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json');
  const topo = await res.json();
  const decodedArcs = decodeArcs(topo);
  const geometries = topo.objects.countries.geometries;

  const canvas = document.createElement('canvas');
  canvas.width = TEX_W;
  canvas.height = TEX_H;
  const ctx = canvas.getContext('2d');

  // Background — dark
  ctx.fillStyle = '#050a05';
  ctx.fillRect(0, 0, TEX_W, TEX_H);

  // Grid lines
  ctx.strokeStyle = 'rgba(0, 255, 136, 0.1)';
  ctx.lineWidth = 1;
  for (let lat = -80; lat <= 80; lat += 10) {
    ctx.beginPath();
    const [, y] = projectEquirectangular(0, lat);
    ctx.moveTo(0, y);
    ctx.lineTo(TEX_W, y);
    ctx.stroke();
  }
  for (let lng = -180; lng <= 180; lng += 10) {
    ctx.beginPath();
    const [x] = projectEquirectangular(lng, 0);
    ctx.moveTo(x, 0);
    ctx.lineTo(x, TEX_H);
    ctx.stroke();
  }

  // Country index for color-pick lookup
  const countryIndex = []; // index 0 unused (background)

  // Hidden lookup canvas — each country painted with unique color
  const pickCanvas = document.createElement('canvas');
  pickCanvas.width = TEX_W;
  pickCanvas.height = TEX_H;
  const pickCtx = pickCanvas.getContext('2d', { willReadFrequently: true });
  pickCtx.fillStyle = '#000000';
  pickCtx.fillRect(0, 0, TEX_W, TEX_H);

  function drawCountryPath(targetCtx, polygons) {
    for (const polygon of polygons) {
      for (let r = 0; r < polygon.length; r++) {
        const ring = polygon[r];
        if (ring.length < 3) continue;
        targetCtx.beginPath();
        const [sx, sy] = projectEquirectangular(ring[0][0], ring[0][1]);
        targetCtx.moveTo(sx, sy);
        let prevX = sx;
        for (let i = 1; i < ring.length; i++) {
          const [px, py] = projectEquirectangular(ring[i][0], ring[i][1]);
          if (Math.abs(px - prevX) > TEX_W * 0.5) {
            targetCtx.moveTo(px, py);
          } else {
            targetCtx.lineTo(px, py);
          }
          prevX = px;
        }
        targetCtx.closePath();
      }
    }
  }

  // Draw each country
  for (const geom of geometries) {
    const name = (geom.properties && geom.properties.name) || '';
    const isVisited = VISITED_SET.has(name);
    const polygons = getPolygons(geom, decodedArcs);

    // Add to lookup index (1-based)
    const idx = countryIndex.length + 1;
    countryIndex.push({ name: name || `Unknown-${geom.id}`, isVisited });

    // Encode index as RGB color for the pick canvas
    const cr = (idx >> 16) & 0xff;
    const cg = (idx >> 8) & 0xff;
    const cb = idx & 0xff;
    const pickColor = `rgb(${cr},${cg},${cb})`;
    pickCtx.fillStyle = pickColor;
    pickCtx.strokeStyle = pickColor;
    pickCtx.lineWidth = 4;
    for (const polygon of polygons) {
      for (const ring of polygon) {
        if (ring.length < 3) continue;
        pickCtx.beginPath();
        const [sx, sy] = projectEquirectangular(ring[0][0], ring[0][1]);
        pickCtx.moveTo(sx, sy);
        let prevX = sx;
        for (let i = 1; i < ring.length; i++) {
          const [px, py] = projectEquirectangular(ring[i][0], ring[i][1]);
          if (Math.abs(px - prevX) > TEX_W * 0.5) {
            pickCtx.moveTo(px, py);
          } else {
            pickCtx.lineTo(px, py);
          }
          prevX = px;
        }
        pickCtx.closePath();
        pickCtx.fill();
        pickCtx.stroke();
      }
    }

    // Draw visible version on main canvas
    for (const polygon of polygons) {
      for (let r2 = 0; r2 < polygon.length; r2++) {
        const ring = polygon[r2];
        if (ring.length < 3) continue;
        ctx.beginPath();
        const [sx, sy] = projectEquirectangular(ring[0][0], ring[0][1]);
        ctx.moveTo(sx, sy);
        let prevX = sx;
        for (let i = 1; i < ring.length; i++) {
          const [px, py] = projectEquirectangular(ring[i][0], ring[i][1]);
          if (Math.abs(px - prevX) > TEX_W * 0.5) {
            ctx.moveTo(px, py);
          } else {
            ctx.lineTo(px, py);
          }
          prevX = px;
        }
        ctx.closePath();

        if (r2 === 0) {
          ctx.fillStyle = isVisited ? 'rgba(0, 255, 100, 0.35)' : 'rgba(0, 255, 136, 0.06)';
          ctx.fill();
        }
        ctx.strokeStyle = isVisited ? 'rgba(0, 255, 136, 0.9)' : 'rgba(0, 255, 136, 0.2)';
        ctx.lineWidth = isVisited ? 2 : 1;
        ctx.stroke();
      }
    }
  }

  return { canvas, countryIndex, pickCanvas, pickCtx };
}

// ── Globe mesh ────────────────────────────────────────

const { canvas: texCanvas, countryIndex, pickCanvas, pickCtx } = await buildGlobeTexture();

const texture = new THREE.CanvasTexture(texCanvas);
texture.wrapS = THREE.RepeatWrapping;
texture.needsUpdate = true;

const globeGeo = new THREE.SphereGeometry(1, 96, 64);
const globeMat = new THREE.MeshBasicMaterial({ map: texture });
const globe = new THREE.Mesh(globeGeo, globeMat);
scene.add(globe);

// Atmosphere
const atmosGeo = new THREE.SphereGeometry(1.015, 64, 64);
const atmosMat = new THREE.ShaderMaterial({
  vertexShader: `
    varying vec3 vNormal;
    void main() {
      vNormal = normalize(normalMatrix * normal);
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }`,
  fragmentShader: `
    varying vec3 vNormal;
    void main() {
      float intensity = pow(0.6 - dot(vNormal, vec3(0,0,1)), 3.0);
      gl_FragColor = vec4(0.0, 1.0, 0.53, 1.0) * intensity * 0.25;
    }`,
  blending: THREE.AdditiveBlending,
  side: THREE.BackSide,
  transparent: true
});
scene.add(new THREE.Mesh(atmosGeo, atmosMat));

// Wireframe overlay for tech feel
const wireGeo = new THREE.SphereGeometry(1.002, 36, 18);
const wireMat = new THREE.MeshBasicMaterial({
  color: 0x00ff88,
  wireframe: true,
  transparent: true,
  opacity: 0.02
});
scene.add(new THREE.Mesh(wireGeo, wireMat));

// Stars
const starsGeo = new THREE.BufferGeometry();
const starPos = [];
for (let i = 0; i < 2000; i++) {
  starPos.push((Math.random() - 0.5) * 80, (Math.random() - 0.5) * 80, (Math.random() - 0.5) * 80);
}
starsGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
scene.add(new THREE.Points(starsGeo, new THREE.PointsMaterial({
  color: 0x00ff88, size: 0.04, transparent: true, opacity: 0.4
})));

// ── Markers on visited countries ──────────────────────

const MARKERS = [
  { name: 'United States', lat: 39.8, lng: -98.5 },
  { name: 'Mexico', lat: 23.6, lng: -102.5 },
  { name: 'United Kingdom', lat: 54.0, lng: -2.0 },
  { name: 'Turkiye', lat: 39.9, lng: 32.8 },
  { name: 'Switzerland', lat: 46.8, lng: 8.2 },
  { name: 'Spain', lat: 40.4, lng: -3.7 },
  { name: 'Portugal', lat: 39.4, lng: -8.2 },
  { name: 'Poland', lat: 51.9, lng: 19.1 },
  { name: 'Netherlands', lat: 52.1, lng: 5.3 },
  { name: 'Italy', lat: 41.9, lng: 12.5 },
  { name: 'Ireland', lat: 53.1, lng: -7.7 },
  { name: 'Iceland', lat: 64.9, lng: -19.0 },
  { name: 'Hungary', lat: 47.2, lng: 19.5 },
  { name: 'Greece', lat: 39.1, lng: 21.8 },
  { name: 'Germany', lat: 51.2, lng: 10.4 },
  { name: 'France', lat: 46.2, lng: 2.2 },
  { name: 'Czechia', lat: 49.8, lng: 15.5 },
  { name: 'Belgium', lat: 50.5, lng: 4.5 },
  { name: 'Austria', lat: 47.5, lng: 14.6 },
  { name: 'Thailand', lat: 15.9, lng: 100.9 },
  { name: 'Taiwan', lat: 23.7, lng: 121.0 },
  { name: 'South Korea', lat: 35.9, lng: 127.8 },
  { name: 'Japan', lat: 36.2, lng: 138.3 },
  { name: 'Israel', lat: 31.0, lng: 34.9 },
  { name: 'India', lat: 20.6, lng: 79.0 },
  { name: 'China', lat: 35.9, lng: 104.2 },
  { name: 'Morocco', lat: 31.8, lng: -7.1 },
  { name: 'Argentina', lat: -38.4, lng: -63.6 },
  { name: 'Uruguay', lat: -32.5, lng: -55.8 }
];

function latLngTo3D(lat, lng, r = 1.003) {
  const phi = (90 - lat) * Math.PI / 180;
  const theta = (lng - 180) * Math.PI / 180;
  return new THREE.Vector3(
    -r * Math.sin(phi) * Math.cos(theta),
    r * Math.cos(phi),
    r * Math.sin(phi) * Math.sin(theta)
  );
}

const markerMeshes = [];
MARKERS.forEach(m => {
  const pos = latLngTo3D(m.lat, m.lng);

  // Glowing dot
  const dotGeo = new THREE.SphereGeometry(0.007, 8, 8);
  const dotMat = new THREE.MeshBasicMaterial({ color: 0x00ff88 });
  const dot = new THREE.Mesh(dotGeo, dotMat);
  dot.position.copy(pos);
  scene.add(dot);

  // Vertical spike
  const spikePos = latLngTo3D(m.lat, m.lng, 1.04);
  const spikeGeo = new THREE.BufferGeometry().setFromPoints([pos, spikePos]);
  const spikeMat = new THREE.LineBasicMaterial({ color: 0x00ff88, transparent: true, opacity: 0.35 });
  scene.add(new THREE.Line(spikeGeo, spikeMat));

  markerMeshes.push({ mesh: dot, name: m.name });
});

// ── Raycasting for hover (color-pick method) ─────────

const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
const hoverEl = document.getElementById('country-hover');
const hoverNameEl = document.getElementById('hover-name');
const hoverRegionEl = document.getElementById('hover-region');
const hoverNativeEl = document.getElementById('hover-native');
const hoverDatesEl = document.getElementById('hover-dates');
const hoverStatusEl = document.getElementById('hover-status');

function getCountryAtUV(uv) {
  // Sample the pick canvas at this UV coordinate
  const px = Math.floor(uv.x * (TEX_W - 1));
  const py = Math.floor((1 - uv.y) * (TEX_H - 1));
  const pixel = pickCtx.getImageData(px, py, 1, 1).data;
  const idx = (pixel[0] << 16) | (pixel[1] << 8) | pixel[2];
  if (idx === 0) return null; // background
  if (idx - 1 < countryIndex.length) return countryIndex[idx - 1];
  return null;
}

// ── Anthem audio ──────────────────────────────────────

let audioUnlocked = false;
let currentAnthem = null;
let currentAnthemCountry = null;
const FADE_DURATION = 600;
const audioPromptEl = document.getElementById('audio-prompt');

// Unlock audio on any click
function unlockAudio() {
  if (audioUnlocked) return;
  audioUnlocked = true;
  audioPromptEl.classList.add('hidden');
  // Create and play a silent buffer to unlock the audio context
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const buf = ctx.createBuffer(1, 1, 22050);
  const src = ctx.createBufferSource();
  src.buffer = buf;
  src.connect(ctx.destination);
  src.start(0);
}
document.addEventListener('click', unlockAudio, { once: false });

function fadeOutAnthem() {
  if (!currentAnthem) return;
  const audio = currentAnthem;
  const startVol = audio.volume;
  const startTime = performance.now();
  function fade() {
    const elapsed = performance.now() - startTime;
    const t = Math.min(elapsed / FADE_DURATION, 1);
    audio.volume = startVol * (1 - t);
    if (t < 1) {
      requestAnimationFrame(fade);
    } else {
      audio.pause();
      audio.currentTime = 0;
      audio.volume = 1;
    }
  }
  fade();
  currentAnthem = null;
  currentAnthemCountry = null;
}

function playAnthem(countryName, url) {
  if (!audioUnlocked) return;
  if (currentAnthemCountry === countryName) return;
  fadeOutAnthem();
  const audio = new Audio(url);
  audio.volume = 0;
  audio.loop = true;
  currentAnthem = audio;
  currentAnthemCountry = countryName;
  audio.play().then(() => {
    const startTime = performance.now();
    function fadeIn() {
      if (currentAnthem !== audio) return;
      const elapsed = performance.now() - startTime;
      const t = Math.min(elapsed / FADE_DURATION, 1);
      audio.volume = t * 0.35;
      if (t < 1) requestAnimationFrame(fadeIn);
    }
    fadeIn();
  }).catch(() => {});
}

renderer.domElement.addEventListener('mousemove', (e) => {
  mouse.x = (e.clientX / innerWidth) * 2 - 1;
  mouse.y = -(e.clientY / innerHeight) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);
  const hits = raycaster.intersectObject(globe);

  if (hits.length > 0 && hits[0].uv) {
    const country = getCountryAtUV(hits[0].uv);
    if (country && country.name && country.isVisited) {
      const data = VISITED_DATA[country.name];
      hoverNameEl.textContent = data.display;
      hoverNativeEl.textContent = data.native !== data.display ? data.native : '';
      hoverRegionEl.textContent = data.region;
      hoverDatesEl.textContent = data.dates ? '// ' + data.dates : '';
      hoverStatusEl.textContent = '[VISITED]';
      hoverEl.classList.add('visible');
      if (data.anthem) playAnthem(country.name, data.anthem);
    } else {
      hoverEl.classList.remove('visible');
      fadeOutAnthem();
    }
  } else {
    hoverEl.classList.remove('visible');
    fadeOutAnthem();
  }
});

// ── HUD readouts ──────────────────────────────────────

const rotXEl = document.getElementById('rot-x');
const rotYEl = document.getElementById('rot-y');
const zoomEl = document.getElementById('zoom-val');
const fpsEl = document.getElementById('fps-val');
let lastTime = performance.now();
let frameCount = 0;
let fps = 60;

// ── Animate ───────────────────────────────────────────

function animate() {
  requestAnimationFrame(animate);
  controls.update();

  // FPS
  frameCount++;
  const now = performance.now();
  if (now - lastTime >= 500) {
    fps = Math.round(frameCount / ((now - lastTime) / 1000));
    lastTime = now;
    frameCount = 0;
  }

  // HUD
  const azimuth = controls.getAzimuthalAngle();
  const polar = controls.getPolarAngle();
  rotXEl.textContent = polar.toFixed(3);
  rotYEl.textContent = azimuth.toFixed(3);
  zoomEl.textContent = camera.position.length().toFixed(2);
  fpsEl.textContent = fps;

  renderer.render(scene, camera);
}
animate();

// Resize
addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
</script>

</body>
</html>
